# èœå•æƒé™ä½¿ç”¨æŒ‡å—

## ğŸ“¦ å·²å®æ–½å†…å®¹

### âœ… æ•°æ®åº“è„šæœ¬
1. **init_menu_full.sql** - å®Œæ•´èœå•åˆå§‹åŒ–è„šæœ¬ï¼ˆå…¨æ–°å®‰è£…ä½¿ç”¨ï¼‰
2. **V20251003_5__update_menu_codegen.sql** - ä»£ç ç”Ÿæˆæ¨¡å—å¢é‡è„šæœ¬ï¼ˆå·²æœ‰ç³»ç»Ÿä½¿ç”¨ï¼‰

### âœ… å‰ç«¯å·¥å…·ç±»
1. **menuUtils.ts** - èœå•æ•°æ®å¤„ç†å·¥å…·
2. **usePermission.ts** - æƒé™æ£€æŸ¥ Hook

### âœ… æ–‡æ¡£
1. **èœå•æƒé™å¯¹ç…§è¡¨.md** - å®Œæ•´çš„èœå•ç»“æ„å’Œæƒé™å¯¹ç…§

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šåˆå§‹åŒ–èœå•æ•°æ®

#### åœºæ™¯Aï¼šå…¨æ–°å®‰è£…ç³»ç»Ÿ
```bash
# è¿›å…¥ SQL ç›®å½•
cd nexus-boot/nexus-backend-admin/src/main/resources/sql

# æ‰§è¡Œå®Œæ•´åˆå§‹åŒ–è„šæœ¬
mysql -u root -p database_name < init_menu_full.sql
```

#### åœºæ™¯Bï¼šå·²æœ‰ç³»ç»Ÿï¼Œæ·»åŠ ä»£ç ç”Ÿæˆæ¨¡å—
```bash
# æ‰§è¡Œå¢é‡æ›´æ–°è„šæœ¬
mysql -u root -p database_name < V20251003_5__update_menu_codegen.sql
```

### æ­¥éª¤ 2ï¼šéªŒè¯æ•°æ®

```sql
-- æŸ¥çœ‹æ‰€æœ‰èœå•
SELECT id, name, type, parent_id, path, permission 
FROM system_menu 
ORDER BY id;

-- æŸ¥çœ‹è¶…çº§ç®¡ç†å‘˜æƒé™
SELECT COUNT(*) as èœå•æ•°é‡ 
FROM system_role_menu 
WHERE role_id = 1;
```

---

## ğŸ“‹ èœå•ç»“æ„

### å®Œæ•´èœå•æ ‘
```
nexus-boot ç®¡ç†ç³»ç»Ÿ
â”œâ”€ ç³»ç»Ÿç®¡ç† (ID: 1)
â”‚  â”œâ”€ ç”¨æˆ·ç®¡ç† (ID: 100) - 4ä¸ªæŒ‰é’®æƒé™
â”‚  â”œâ”€ è§’è‰²ç®¡ç† (ID: 101) - 5ä¸ªæŒ‰é’®æƒé™
â”‚  â””â”€ èœå•ç®¡ç† (ID: 102) - 4ä¸ªæŒ‰é’®æƒé™
â”‚
â””â”€ ç ”å‘å·¥å…· (ID: 2)
   â””â”€ ä»£ç ç”Ÿæˆ (ID: 200) - 6ä¸ªæŒ‰é’®æƒé™
```

### ID åˆ†é…è§„åˆ™
- **ç›®å½•**: 1-99
- **èœå•**: 100-999
- **æŒ‰é’®**: 1000-9999

### æƒé™æ ‡è¯†è§„èŒƒ
```
æ ¼å¼: æ¨¡å—:åŠŸèƒ½:æ“ä½œ
ç¤ºä¾‹: system:user:create
```

---

## ğŸ’» å‰ç«¯é›†æˆ

### 1. ä½¿ç”¨èœå•å·¥å…·ç±»

```typescript
import { 
  buildMenuTree, 
  filterButtonMenus, 
  getButtonPermissions,
  generateRoutes,
  getFirstMenuPath 
} from '@/utils/menuUtils';

// è·å–èœå•æ•°æ®
const menuList = await menuApi.getMenuTree();

// æ„å»ºèœå•æ ‘
const menuTree = buildMenuTree(menuList);

// è¿‡æ»¤æŒ‰é’®ï¼Œåªä¿ç•™ç›®å½•å’Œèœå•
const displayMenus = filterButtonMenus(menuTree);

// è·å–æ‰€æœ‰æŒ‰é’®æƒé™
const permissions = getButtonPermissions(menuTree);

// ç”Ÿæˆè·¯ç”±é…ç½®
const routes = generateRoutes(menuTree);

// è·å–é»˜è®¤é¦–é¡µè·¯å¾„
const defaultPath = getFirstMenuPath(menuTree);
```

### 2. ä½¿ç”¨æƒé™æ£€æŸ¥ Hook

```typescript
import { usePermission } from '@/hooks/usePermission';

const MyComponent = () => {
  const { hasPermission, hasAnyPermission } = usePermission();

  return (
    <>
      {/* å•ä¸ªæƒé™æ£€æŸ¥ */}
      {hasPermission('system:user:create') && (
        <Button onClick={handleCreate}>æ–°å¢</Button>
      )}

      {/* å¤šä¸ªæƒé™æ£€æŸ¥ï¼ˆä»»æ„ä¸€ä¸ªï¼‰ */}
      {hasAnyPermission(['system:user:update', 'system:user:delete']) && (
        <Space>
          <Button onClick={handleEdit}>ç¼–è¾‘</Button>
          <Button onClick={handleDelete}>åˆ é™¤</Button>
        </Space>
      )}
    </>
  );
};
```

### 3. ä½¿ç”¨æƒé™æŒ‰é’®ç»„ä»¶

```typescript
import { PermissionButton } from '@/hooks/usePermission';

const MyComponent = () => {
  return (
    <>
      <PermissionButton permission="system:user:create">
        <Button>æ–°å¢</Button>
      </PermissionButton>

      <PermissionButton permission="system:user:update">
        <Button>ç¼–è¾‘</Button>
      </PermissionButton>
    </>
  );
};
```

---

## ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šä¾§è¾¹æ èœå•å±•ç¤º

```typescript
import { useEffect, useState } from 'react';
import { Menu } from 'antd';
import { menuApi } from '@/services/menu';
import { buildMenuTree, filterButtonMenus } from '@/utils/menuUtils';

const Sidebar = () => {
  const [menuItems, setMenuItems] = useState([]);

  useEffect(() => {
    const loadMenu = async () => {
      // 1. è·å–ç”¨æˆ·èœå•æ•°æ®
      const menuList = await menuApi.getMenuTree();
      
      // 2. æ„å»ºèœå•æ ‘
      const tree = buildMenuTree(menuList);
      
      // 3. è¿‡æ»¤æŒ‰é’®æƒé™
      const displayMenus = filterButtonMenus(tree);
      
      // 4. è½¬æ¢ä¸º Ant Design Menu æ ¼å¼
      const items = convertToMenuItems(displayMenus);
      
      setMenuItems(items);
    };

    loadMenu();
  }, []);

  return <Menu items={menuItems} />;
};
```

### åœºæ™¯ 2ï¼šåŠ¨æ€è·¯ç”±åŠ è½½

```typescript
import { lazy } from 'react';
import { generateRoutes } from '@/utils/menuUtils';
import type { RouteObject } from 'react-router-dom';

// ç»„ä»¶æ˜ å°„è¡¨
const componentMap: Record<string, any> = {
  'Layout': lazy(() => import('@/layouts/MainLayout')),
  'system/user/UserList': lazy(() => import('@/pages/system/user/UserList')),
  'system/role/index': lazy(() => import('@/pages/system/role/index')),
  'system/menu/index': lazy(() => import('@/pages/system/menu/index')),
  'codegen/TableList': lazy(() => import('@/pages/codegen/TableList')),
};

export const generateDynamicRoutes = (menuList: Menu[]): RouteObject[] => {
  const routes = generateRoutes(menuList);
  
  return routes.map(route => ({
    path: route.path,
    element: componentMap[route.component || ''],
    children: route.children ? generateDynamicRoutes(route.children) : undefined,
  }));
};
```

### åœºæ™¯ 3ï¼šæŒ‰é’®æƒé™æ§åˆ¶

```typescript
// ç”¨æˆ·ç®¡ç†é¡µé¢
import { usePermission } from '@/hooks/usePermission';

const UserList = () => {
  const { hasPermission } = usePermission();

  return (
    <div>
      <Space>
        {hasPermission('system:user:create') && (
          <Button type="primary" onClick={handleCreate}>
            æ–°å¢ç”¨æˆ·
          </Button>
        )}
        
        {hasPermission('system:user:delete') && (
          <Button danger onClick={handleBatchDelete}>
            æ‰¹é‡åˆ é™¤
          </Button>
        )}
      </Space>

      <Table
        columns={[
          // ...å…¶ä»–åˆ—
          {
            title: 'æ“ä½œ',
            render: (_, record) => (
              <Space>
                {hasPermission('system:user:update') && (
                  <Button size="small" onClick={() => handleEdit(record)}>
                    ç¼–è¾‘
                  </Button>
                )}
                
                {hasPermission('system:user:delete') && (
                  <Button size="small" danger onClick={() => handleDelete(record)}>
                    åˆ é™¤
                  </Button>
                )}
              </Space>
            ),
          },
        ]}
      />
    </div>
  );
};
```

---

## ğŸ”§ åç«¯é›†æˆï¼ˆå¾…å®ç°ï¼‰

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Spring Security + è‡ªå®šä¹‰æ³¨è§£

```java
// è‡ªå®šä¹‰æƒé™æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermission {
    String value();
}

// Controller ä¸­ä½¿ç”¨
@RestController
@RequestMapping("/api/system/user")
public class UserController {
    
    @GetMapping("/page")
    @RequiresPermission("system:user:query")
    public Result<PageResult<User>> getPage() {
        // ...
    }
    
    @PostMapping
    @RequiresPermission("system:user:create")
    public Result<Long> create(@RequestBody UserForm form) {
        // ...
    }
}
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ‹¦æˆªå™¨

```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        // 1. è·å–æ–¹æ³•ä¸Šçš„æƒé™æ³¨è§£
        RequiresPermission annotation = getAnnotation(handler);
        if (annotation == null) {
            return true;
        }
        
        // 2. è·å–å½“å‰ç”¨æˆ·æƒé™
        Set<String> permissions = getCurrentUserPermissions();
        
        // 3. æ ¡éªŒæƒé™
        if (!permissions.contains(annotation.value())) {
            throw new PermissionDeniedException("æ— æƒé™è®¿é—®");
        }
        
        return true;
    }
}
```

---

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### èœå•æ•°æ®ç¤ºä¾‹
```json
{
  "id": 200,
  "name": "ä»£ç ç”Ÿæˆ",
  "permission": "codegen:table:query",
  "type": 2,
  "sort": 1,
  "parentId": 2,
  "path": "codegen",
  "icon": "code",
  "component": "codegen/TableList",
  "componentName": "CodegenTableList",
  "status": 1,
  "visible": 1,
  "keepAlive": 1,
  "children": [
    {
      "id": 2001,
      "name": "æŸ¥è¯¢",
      "permission": "codegen:table:query",
      "type": 3,
      "sort": 1,
      "parentId": 200
    }
  ]
}
```

### ç”¨æˆ·æƒé™æ•°æ®ç¤ºä¾‹
```json
[
  "system:user:query",
  "system:user:create",
  "system:user:update",
  "system:role:query",
  "codegen:table:query",
  "codegen:table:import"
]
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™æ ‡è¯†å‘½å
- âœ… æ­£ç¡®: `system:user:create`
- âŒ é”™è¯¯: `SystemUserCreate`, `sys-user-create`

### 2. ç»„ä»¶è·¯å¾„é…ç½®
- å‰ç«¯ç»„ä»¶è·¯å¾„å¿…é¡»ä¸å®é™…æ–‡ä»¶è·¯å¾„åŒ¹é…
- ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œä¸è¦ä»¥ `/` å¼€å¤´
- ç›®å½•ä½¿ç”¨ `Layout` ä½œä¸ºç»„ä»¶

### 3. è·¯ç”±è·¯å¾„é…ç½®
- ç›®å½•è·¯ç”±ä»¥ `/` å¼€å¤´
- å­èœå•è·¯ç”±ä½¿ç”¨ç›¸å¯¹è·¯å¾„
- å®Œæ•´è·¯å¾„ç”±çˆ¶å­è·¯å¾„æ‹¼æ¥è€Œæˆ

### 4. èœå•ç±»å‹è¯´æ˜
- **ç›®å½• (type=1)**: åªç”¨äºç»„ç»‡ç»“æ„ï¼Œä¸å…³è”å…·ä½“é¡µé¢
- **èœå• (type=2)**: å…³è”å…·ä½“é¡µé¢ï¼Œéœ€è¦é…ç½®ç»„ä»¶è·¯å¾„
- **æŒ‰é’® (type=3)**: é¡µé¢å†…æ“ä½œæƒé™ï¼Œä¸ç”Ÿæˆè·¯ç”±

---

## ğŸ“ æ‰©å±•é˜…è¯»

### ç›¸å…³æ–‡æ¡£
- [èœå•æƒé™å¯¹ç…§è¡¨](./èœå•æƒé™å¯¹ç…§è¡¨.md)
- [RBACå®æ–½æ€»ç»“](./RBACå®æ–½æ€»ç»“.md)

### å‚è€ƒèµ„æ–™
- [Spring Security æƒé™ç®¡ç†](https://spring.io/projects/spring-security)
- [React Router åŠ¨æ€è·¯ç”±](https://reactrouter.com/)
- [Ant Design Menu ç»„ä»¶](https://ant.design/components/menu-cn/)

---

**ğŸ“… åˆ›å»ºæ—¶é—´ï¼š** 2025-10-03  
**ğŸ“… æ›´æ–°æ—¶é—´ï¼š** 2025-10-03  
**ğŸ‘¨â€ğŸ’» ç»´æŠ¤è€…ï¼š** nexus-codegen-team



