# 菜单权限使用指南

## 📦 已实施内容

### ✅ 数据库脚本
1. **init_menu_full.sql** - 完整菜单初始化脚本（全新安装使用）
2. **V20251003_5__update_menu_codegen.sql** - 代码生成模块增量脚本（已有系统使用）

### ✅ 前端工具类
1. **menuUtils.ts** - 菜单数据处理工具
2. **usePermission.ts** - 权限检查 Hook

### ✅ 文档
1. **菜单权限对照表.md** - 完整的菜单结构和权限对照

---

## 🚀 快速开始

### 步骤 1：初始化菜单数据

#### 场景A：全新安装系统
```bash
# 进入 SQL 目录
cd nexus-boot/nexus-backend-admin/src/main/resources/sql

# 执行完整初始化脚本
mysql -u root -p database_name < init_menu_full.sql
```

#### 场景B：已有系统，添加代码生成模块
```bash
# 执行增量更新脚本
mysql -u root -p database_name < V20251003_5__update_menu_codegen.sql
```

### 步骤 2：验证数据

```sql
-- 查看所有菜单
SELECT id, name, type, parent_id, path, permission 
FROM system_menu 
ORDER BY id;

-- 查看超级管理员权限
SELECT COUNT(*) as 菜单数量 
FROM system_role_menu 
WHERE role_id = 1;
```

---

## 📋 菜单结构

### 完整菜单树
```
nexus-boot 管理系统
├─ 系统管理 (ID: 1)
│  ├─ 用户管理 (ID: 100) - 4个按钮权限
│  ├─ 角色管理 (ID: 101) - 5个按钮权限
│  └─ 菜单管理 (ID: 102) - 4个按钮权限
│
└─ 研发工具 (ID: 2)
   └─ 代码生成 (ID: 200) - 6个按钮权限
```

### ID 分配规则
- **目录**: 1-99
- **菜单**: 100-999
- **按钮**: 1000-9999

### 权限标识规范
```
格式: 模块:功能:操作
示例: system:user:create
```

---

## 💻 前端集成

### 1. 使用菜单工具类

```typescript
import { 
  buildMenuTree, 
  filterButtonMenus, 
  getButtonPermissions,
  generateRoutes,
  getFirstMenuPath 
} from '@/utils/menuUtils';

// 获取菜单数据
const menuList = await menuApi.getMenuTree();

// 构建菜单树
const menuTree = buildMenuTree(menuList);

// 过滤按钮，只保留目录和菜单
const displayMenus = filterButtonMenus(menuTree);

// 获取所有按钮权限
const permissions = getButtonPermissions(menuTree);

// 生成路由配置
const routes = generateRoutes(menuTree);

// 获取默认首页路径
const defaultPath = getFirstMenuPath(menuTree);
```

### 2. 使用权限检查 Hook

```typescript
import { usePermission } from '@/hooks/usePermission';

const MyComponent = () => {
  const { hasPermission, hasAnyPermission } = usePermission();

  return (
    <>
      {/* 单个权限检查 */}
      {hasPermission('system:user:create') && (
        <Button onClick={handleCreate}>新增</Button>
      )}

      {/* 多个权限检查（任意一个） */}
      {hasAnyPermission(['system:user:update', 'system:user:delete']) && (
        <Space>
          <Button onClick={handleEdit}>编辑</Button>
          <Button onClick={handleDelete}>删除</Button>
        </Space>
      )}
    </>
  );
};
```

### 3. 使用权限按钮组件

```typescript
import { PermissionButton } from '@/hooks/usePermission';

const MyComponent = () => {
  return (
    <>
      <PermissionButton permission="system:user:create">
        <Button>新增</Button>
      </PermissionButton>

      <PermissionButton permission="system:user:update">
        <Button>编辑</Button>
      </PermissionButton>
    </>
  );
};
```

---

## 🎯 实际应用场景

### 场景 1：侧边栏菜单展示

```typescript
import { useEffect, useState } from 'react';
import { Menu } from 'antd';
import { menuApi } from '@/services/menu';
import { buildMenuTree, filterButtonMenus } from '@/utils/menuUtils';

const Sidebar = () => {
  const [menuItems, setMenuItems] = useState([]);

  useEffect(() => {
    const loadMenu = async () => {
      // 1. 获取用户菜单数据
      const menuList = await menuApi.getMenuTree();
      
      // 2. 构建菜单树
      const tree = buildMenuTree(menuList);
      
      // 3. 过滤按钮权限
      const displayMenus = filterButtonMenus(tree);
      
      // 4. 转换为 Ant Design Menu 格式
      const items = convertToMenuItems(displayMenus);
      
      setMenuItems(items);
    };

    loadMenu();
  }, []);

  return <Menu items={menuItems} />;
};
```

### 场景 2：动态路由加载

```typescript
import { lazy } from 'react';
import { generateRoutes } from '@/utils/menuUtils';
import type { RouteObject } from 'react-router-dom';

// 组件映射表
const componentMap: Record<string, any> = {
  'Layout': lazy(() => import('@/layouts/MainLayout')),
  'system/user/UserList': lazy(() => import('@/pages/system/user/UserList')),
  'system/role/index': lazy(() => import('@/pages/system/role/index')),
  'system/menu/index': lazy(() => import('@/pages/system/menu/index')),
  'codegen/TableList': lazy(() => import('@/pages/codegen/TableList')),
};

export const generateDynamicRoutes = (menuList: Menu[]): RouteObject[] => {
  const routes = generateRoutes(menuList);
  
  return routes.map(route => ({
    path: route.path,
    element: componentMap[route.component || ''],
    children: route.children ? generateDynamicRoutes(route.children) : undefined,
  }));
};
```

### 场景 3：按钮权限控制

```typescript
// 用户管理页面
import { usePermission } from '@/hooks/usePermission';

const UserList = () => {
  const { hasPermission } = usePermission();

  return (
    <div>
      <Space>
        {hasPermission('system:user:create') && (
          <Button type="primary" onClick={handleCreate}>
            新增用户
          </Button>
        )}
        
        {hasPermission('system:user:delete') && (
          <Button danger onClick={handleBatchDelete}>
            批量删除
          </Button>
        )}
      </Space>

      <Table
        columns={[
          // ...其他列
          {
            title: '操作',
            render: (_, record) => (
              <Space>
                {hasPermission('system:user:update') && (
                  <Button size="small" onClick={() => handleEdit(record)}>
                    编辑
                  </Button>
                )}
                
                {hasPermission('system:user:delete') && (
                  <Button size="small" danger onClick={() => handleDelete(record)}>
                    删除
                  </Button>
                )}
              </Space>
            ),
          },
        ]}
      />
    </div>
  );
};
```

---

## 🔧 后端集成（待实现）

### 方案 1：使用 Spring Security + 自定义注解

```java
// 自定义权限注解
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermission {
    String value();
}

// Controller 中使用
@RestController
@RequestMapping("/api/system/user")
public class UserController {
    
    @GetMapping("/page")
    @RequiresPermission("system:user:query")
    public Result<PageResult<User>> getPage() {
        // ...
    }
    
    @PostMapping
    @RequiresPermission("system:user:create")
    public Result<Long> create(@RequestBody UserForm form) {
        // ...
    }
}
```

### 方案 2：使用拦截器

```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        // 1. 获取方法上的权限注解
        RequiresPermission annotation = getAnnotation(handler);
        if (annotation == null) {
            return true;
        }
        
        // 2. 获取当前用户权限
        Set<String> permissions = getCurrentUserPermissions();
        
        // 3. 校验权限
        if (!permissions.contains(annotation.value())) {
            throw new PermissionDeniedException("无权限访问");
        }
        
        return true;
    }
}
```

---

## 📊 数据示例

### 菜单数据示例
```json
{
  "id": 200,
  "name": "代码生成",
  "permission": "codegen:table:query",
  "type": 2,
  "sort": 1,
  "parentId": 2,
  "path": "codegen",
  "icon": "code",
  "component": "codegen/TableList",
  "componentName": "CodegenTableList",
  "status": 1,
  "visible": 1,
  "keepAlive": 1,
  "children": [
    {
      "id": 2001,
      "name": "查询",
      "permission": "codegen:table:query",
      "type": 3,
      "sort": 1,
      "parentId": 200
    }
  ]
}
```

### 用户权限数据示例
```json
[
  "system:user:query",
  "system:user:create",
  "system:user:update",
  "system:role:query",
  "codegen:table:query",
  "codegen:table:import"
]
```

---

## ⚠️ 注意事项

### 1. 权限标识命名
- ✅ 正确: `system:user:create`
- ❌ 错误: `SystemUserCreate`, `sys-user-create`

### 2. 组件路径配置
- 前端组件路径必须与实际文件路径匹配
- 使用相对路径，不要以 `/` 开头
- 目录使用 `Layout` 作为组件

### 3. 路由路径配置
- 目录路由以 `/` 开头
- 子菜单路由使用相对路径
- 完整路径由父子路径拼接而成

### 4. 菜单类型说明
- **目录 (type=1)**: 只用于组织结构，不关联具体页面
- **菜单 (type=2)**: 关联具体页面，需要配置组件路径
- **按钮 (type=3)**: 页面内操作权限，不生成路由

---

## 🎓 扩展阅读

### 相关文档
- [菜单权限对照表](./菜单权限对照表.md)
- [RBAC实施总结](./RBAC实施总结.md)

### 参考资料
- [Spring Security 权限管理](https://spring.io/projects/spring-security)
- [React Router 动态路由](https://reactrouter.com/)
- [Ant Design Menu 组件](https://ant.design/components/menu-cn/)

---

**📅 创建时间：** 2025-10-03  
**📅 更新时间：** 2025-10-03  
**👨‍💻 维护者：** nexus-codegen-team



