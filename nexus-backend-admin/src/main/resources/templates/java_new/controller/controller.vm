package ${packageName}.controller.${businessName};

import cn.hutool.core.bean.BeanUtil;
import com.nexus.framework.web.result.Result;
#if($templateType != 2)
import com.nexus.framework.web.result.PageResult;
#end
import ${packageName}.controller.${businessName}.vo.*;
import ${packageName}.dal.dataobject.${businessName}.${className}DO;
#if($templateType == 3)
import ${packageName}.dal.dataobject.${businessName}.${subTable.className}DO;
#end
import ${packageName}.service.${businessName}.${className}Service;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.validation.annotation.Validated;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.NotEmpty;
import java.util.List;
import java.util.stream.Collectors;

/**
 * ${classComment} 控制器
 *
 * @author ${author}
 * @since ${date}
 */
@Slf4j
@RestController
@RequestMapping("/${moduleName}/${businessName}")
@RequiredArgsConstructor
@Validated
public class ${className}Controller {

    private final ${className}Service ${classNameFirstLower}Service;

    /**
     * 创建${classComment}
     *
     * @param createReqVO 创建请求
     * @return 创建的记录ID
     */
    @PostMapping
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:create')")
    public Result<Long> create(@Valid @RequestBody ${className}SaveReqVO createReqVO) {
        Long id = ${classNameFirstLower}Service.create(createReqVO);
        return Result.success(id);
    }

    /**
     * 更新${classComment}
     *
     * @param id 记录ID
     * @param updateReqVO 更新请求
     * @return 成功结果
     */
    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:update')")
    public Result<Void> update(@PathVariable @NotNull Long id,
                                @Valid @RequestBody ${className}SaveReqVO updateReqVO) {
        updateReqVO.setId(id); // 确保ID传入Service
        ${classNameFirstLower}Service.update(updateReqVO);
        return Result.success();
    }

    /**
     * 删除${classComment}
     *
     * @param id 记录ID
     * @return 成功结果
     */
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:delete')")
    public Result<Void> delete(@PathVariable @NotNull Long id) {
        ${classNameFirstLower}Service.delete(id);
        return Result.success();
    }
#if($templateType == 1 || $templateType == 3)

    /**
     * 批量删除${classComment}
     *
     * @param ids ID列表
     * @return 成功结果
     */
    @DeleteMapping("/batch")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:delete')")
    public Result<Void> deleteBatch(@RequestBody @NotEmpty List<Long> ids) {
        ${classNameFirstLower}Service.deleteBatch(ids);
        return Result.success();
    }
#end

    /**
     * 获得${classComment}详情
     *
     * @param id 记录ID
     * @return ${classComment}详情
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:query')")
    public Result<${className}RespVO> getById(@PathVariable @NotNull Long id) {
        ${className}DO ${classNameFirstLower} = ${classNameFirstLower}Service.getById(id);
        ${className}RespVO respVO = BeanUtil.copyProperties(${classNameFirstLower}, ${className}RespVO.class);
#if($templateType == 3)
        // 获取子表数据
        List<${subTable.className}DO> subList = ${classNameFirstLower}Service.get${subTable.className}ListBy${subJoinColumn.javaField.substring(0,1).toUpperCase()}${subJoinColumn.javaField.substring(1)}(id);
        respVO.set${subTable.className}s(subList);
#end
        return Result.success(respVO);
    }
#if($templateType == 1 || $templateType == 3)

    /**
     * 获得${classComment}分页列表
     *
     * @param pageReqVO 分页查询参数
     * @return 分页结果
     */
    @GetMapping("/page")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:query')")
    public Result<PageResult<${className}RespVO>> getPage(@Valid ${className}PageReqVO pageReqVO) {
        PageResult<${className}RespVO> pageResult = ${classNameFirstLower}Service.getPage(pageReqVO);
        return Result.success(pageResult);
    }

    /**
     * 导出${classComment} Excel
     *
     * @param pageReqVO 查询参数
     */
    @GetMapping("/export")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:export')")
    public void export(@Valid ${className}PageReqVO pageReqVO) {
        List<${className}DO> list = ${classNameFirstLower}Service.getList(pageReqVO);

        // 转换为 VO
        List<${className}RespVO> voList = list.stream()
                .map(item -> BeanUtil.copyProperties(item, ${className}RespVO.class))
                .collect(Collectors.toList());

        // TODO: 实现 Excel 导出逻辑
    }
#elseif($templateType == 2)

    /**
     * 获得${classComment}列表（树形结构）
     *
     * @param listReqVO 查询参数
     * @return 列表结果
     */
    @GetMapping("/list")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:query')")
    public Result<List<${className}RespVO>> getList(@Valid ${className}ListReqVO listReqVO) {
        List<${className}RespVO} list = ${classNameFirstLower}Service.getList(listReqVO);
        return Result.success(list);
    }
#end
#if($templateType == 3)

    // ==================== 子表（${subTable.classComment}） ====================

    /**
     * 获得${subTable.classComment}列表
     *
     * @param ${subJoinColumn.javaField} ${subJoinColumn.columnComment}
     * @return ${subTable.classComment}列表
     */
    @GetMapping("/${subTable.businessName}/list-by-${subJoinColumn.javaField}")
    @PreAuthorize("hasAuthority('${moduleName}:${businessName}:query')")
    public Result<List<${subTable.className}DO>> get${subTable.className}ListBy${subJoinColumn.javaField.substring(0,1).toUpperCase()}${subJoinColumn.javaField.substring(1)}(@RequestParam("${subJoinColumn.javaField}") @NotNull Long ${subJoinColumn.javaField}) {
        List<${subTable.className}DO> list = ${classNameFirstLower}Service.get${subTable.className}ListBy${subJoinColumn.javaField.substring(0,1).toUpperCase()}${subJoinColumn.javaField.substring(1)}(${subJoinColumn.javaField});
        return Result.success(list);
    }
#end
}

