import React, { useEffect } from 'react';
import {
  Form,
  Input,
  Button,
  Space,
  message,
  InputNumber,
  Select,
  Radio,
  DatePicker,
} from 'antd';
import dayjs from 'dayjs';
import { ${classNameFirstLower}Api, type ${className} } from '../../../services/${moduleName}/${businessName}Api';

interface ${className}FormProps {
  initialValues?: ${className} | null;
  onSuccess?: () => void;
  onCancel?: () => void;
}

const ${className}Form: React.FC<${className}FormProps> = ({
  initialValues,
  onSuccess,
  onCancel,
}) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = React.useState(false);

  useEffect(() => {
    if (initialValues) {
      // 转换日期字符串为 dayjs 对象
      const formValues = { ...initialValues };
#foreach($column in $columns)
#if(${column.createOperation} && !${column.primaryKey} && ${column.htmlType} == "datetime")
      if (formValues.${column.javaField}) {
        formValues.${column.javaField} = dayjs(formValues.${column.javaField});
      }
#end
#end
      form.setFieldsValue(formValues);
    } else {
      form.resetFields();
    }
  }, [initialValues, form]);

  const handleSubmit = async (values: any) => {
    setLoading(true);
    try {
      // 转换 dayjs 对象为字符串
      const submitValues = { ...values };
#foreach($column in $columns)
#if(${column.createOperation} && !${column.primaryKey} && ${column.htmlType} == "datetime")
      if (submitValues.${column.javaField}) {
        submitValues.${column.javaField} = submitValues.${column.javaField}.format('YYYY-MM-DDTHH:mm:ss');
      }
#end
#end

      if (initialValues?.id) {
        // 编辑
        await ${classNameFirstLower}Api.update(initialValues.id, submitValues);
        message.success('修改成功');
      } else {
        // 新增
        await ${classNameFirstLower}Api.create(submitValues);
        message.success('创建成功');
      }
      onSuccess?.();
    } catch (error) {
      message.error(initialValues?.id ? '修改失败' : '创建失败');
      console.error('保存失败:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Form
      form={form}
      layout="vertical"
      onFinish={handleSubmit}
      initialValues={initialValues || {}}
    >
#foreach($column in $columns)
#if(${column.createOperation} && !${column.primaryKey})
      <Form.Item
        label="${column.columnComment}"
        name="${column.javaField}"
#if(!${column.nullable})
        rules={[{ required: true, message: '请输入${column.columnComment}' }]}
#end
      >
#if(${column.htmlType} == "textarea")
        <Input.TextArea
          placeholder="请输入${column.columnComment}"
          rows={4}
        />
#elseif(${column.htmlType} == "select")
        <Select placeholder="请选择${column.columnComment}">
          {/* TODO: 添加选项 */}
        </Select>
#elseif(${column.htmlType} == "radio")
        <Radio.Group>
          <Radio value={1}>启用</Radio>
          <Radio value={0}>禁用</Radio>
        </Radio.Group>
#elseif(${column.htmlType} == "datetime")
        <DatePicker
          style={{ width: '100%' }}
          placeholder="请选择${column.columnComment}"
          showTime
        />
#elseif(${column.javaType} == "Integer" || ${column.javaType} == "Long" || ${column.javaType} == "BigDecimal")
        <InputNumber
          style={{ width: '100%' }}
          placeholder="请输入${column.columnComment}"
#if(${column.javaType} == "BigDecimal")
          precision={2}
#end
        />
#elseif(${column.htmlType} == "password")
        <Input.Password placeholder="请输入${column.columnComment}" />
#else
        <Input placeholder="请输入${column.columnComment}" />
#end
      </Form.Item>
#end
#end

      <Form.Item>
        <Space>
          <Button type="primary" htmlType="submit" loading={loading}>
            {initialValues?.id ? '更新' : '创建'}
          </Button>
          <Button onClick={onCancel}>
            取消
          </Button>
        </Space>
      </Form.Item>
    </Form>
  );
};

export default ${className}Form;
