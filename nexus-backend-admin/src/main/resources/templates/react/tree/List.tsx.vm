import React, { useState, useEffect } from 'react';
import { Table, Button, Space, Modal, message, Form, Input, Popconfirm, Card } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, SearchOutlined, ExpandOutlined, ShrinkOutlined } from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import ${className}Form from './Form';
import { ${classNameFirstLower}Api, type ${className} } from '@/services/${moduleName}/${businessName}/${businessName}Api';
import { useMenu as useMenuContext } from '@/contexts/MenuContext';
#set($hasDictColumn = false)
#set($hasQueryDictColumn = false)
#foreach($column in $columns)
#if(${column.listOperationResult} && ${column.dictType} && ${column.dictType} != "")
#set($hasDictColumn = true)
#end
#if(${column.listOperation} && ${column.dictType} && ${column.dictType} != "")
#set($hasQueryDictColumn = true)
#end
#end
#if($hasDictColumn)
import { getDictData } from '@/utils/dictCache';
import type { Dict } from '@/services/system/dict/dictApi';
#end
#if($hasQueryDictColumn)
import DictSelect from '@/components/DictSelect';
#end

/**
 * ${classComment}管理（树表）
 */
const ${className}List: React.FC = () => {
  const [dataSource, setDataSource] = useState<${className}[]>([]);
  const [filteredData, setFilteredData] = useState<${className}[]>([]);
  const [loading, setLoading] = useState(false);
  const [modalVisible, setModalVisible] = useState(false);
  const [editId, setEditId] = useState<number | undefined>();
  const [parentId, setParentId] = useState<number | undefined>();
  const [searchForm] = Form.useForm();
  const { permissions } = useMenuContext();
  const [expandedRowKeys, setExpandedRowKeys] = useState<React.Key[]>([]);
  const [isAllExpanded, setIsAllExpanded] = useState(true);

  // 权限检查函数
  const hasPermission = (permission: string) => {
    return permissions.includes(permission);
  };

#foreach($column in $columns)
#if(${column.listOperationResult} && ${column.dictType} && ${column.dictType} != "")
  const [${column.javaField}DictList, set${column.javaField.substring(0,1).toUpperCase()}${column.javaField.substring(1)}DictList] = useState<Dict[]>([]);
#end
#end

#foreach($column in $columns)
#if(${column.listOperationResult} && ${column.dictType} && ${column.dictType} != "")
  // 加载字典数据：${column.columnComment}
  useEffect(() => {
    getDictData('${column.dictType}').then(data => {
      set${column.javaField.substring(0,1).toUpperCase()}${column.javaField.substring(1)}DictList(data);
    });
  }, []);

  // 获取${column.columnComment}标签
  const get${column.javaField.substring(0,1).toUpperCase()}${column.javaField.substring(1)}Label = (value: any): string => {
    const dict = ${column.javaField}DictList.find(d => d.dictValue === String(value));
    return dict?.dictLabel || String(value);
  };

#end
#end

  // 构建树形数据
  const buildTree = (flatData: ${className}[]): ${className}[] => {
    const map = new Map<number, any>();
    const tree: any[] = [];

    // 第一遍：构建映射
    flatData.forEach((item) => {
      map.set(item.id!, { ...item, children: [] });
    });

    // 第二遍：构建树形结构
    flatData.forEach((item) => {
      const node = map.get(item.id!);
      if (!item.parentId || item.parentId === 0) {
        // 根节点
        tree.push(node);
      } else {
        // 子节点
        const parent = map.get(item.parentId);
        if (parent) {
          parent.children.push(node);
        } else {
          // 如果找不到父节点，作为根节点
          tree.push(node);
        }
      }
    });

    // 删除空的 children 数组
    const removeEmptyChildren = (nodes: any[]) => {
      nodes.forEach((node) => {
        if (node.children && node.children.length === 0) {
          delete node.children;
        } else if (node.children) {
          removeEmptyChildren(node.children);
        }
      });
    };
    removeEmptyChildren(tree);

    return tree;
  };

  // 获取所有节点的ID（递归）
  const getAllNodeKeys = (data: ${className}[]): React.Key[] => {
    const keys: React.Key[] = [];
    const traverse = (nodes: ${className}[]) => {
      nodes.forEach((node) => {
        if (node.id !== undefined) {
          keys.push(node.id);
        }
        if (node.children && node.children.length > 0) {
          traverse(node.children);
        }
      });
    };
    traverse(data);
    return keys;
  };

  // 加载数据
  const loadData = async () => {
    setLoading(true);
    try {
      const data = await ${classNameFirstLower}Api.getList({});
      // 构建树形结构
      const treeData = buildTree(data);
      setDataSource(treeData);
      setFilteredData(treeData);
      // 默认展开所有节点
      const allKeys = getAllNodeKeys(treeData);
      setExpandedRowKeys(allKeys);
    } catch (error) {
      // 错误消息已在 request.ts 中统一处理
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  // 切换展开/收起
  const handleToggleExpand = () => {
    if (isAllExpanded) {
      // 当前是展开状态，则收起
      setExpandedRowKeys([]);
      setIsAllExpanded(false);
    } else {
      // 当前是收起状态，则展开
      const allKeys = getAllNodeKeys(filteredData);
      setExpandedRowKeys(allKeys);
      setIsAllExpanded(true);
    }
  };

  // 搜索
  const handleSearch = () => {
    const values = searchForm.getFieldsValue();
#set($hasQueryConditions = false)
#foreach($column in $columns)
#if(${column.listOperation})
#set($hasQueryConditions = true)
#end
#end
#if($hasQueryConditions)

    // 如果没有查询值，显示全部数据
    const hasSearchValue = Object.values(values).some(v => v !== undefined && v !== '');
    if (!hasSearchValue) {
      setFilteredData(dataSource);
      return;
    }

    // 递归过滤树形数据
    const filterTree = (items: ${className}[]): ${className}[] => {
      return items.reduce((acc: ${className}[], item) => {
        let matches = true;

        // 根据查询条件过滤
#foreach($column in $columns)
#if(${column.listOperation})
        if (values.${column.javaField} && item.${column.javaField}) {
          matches = matches && item.${column.javaField}.toString().toLowerCase().includes(values.${column.javaField}.toLowerCase());
        }
#end
#end

        const children = item.children ? filterTree(item.children) : [];

        // 如果当前节点匹配或子节点有匹配，则保留
        if (matches || children.length > 0) {
          acc.push({
            ...item,
            children: children.length > 0 ? children : item.children,
          });
        }
        return acc;
      }, []);
    };

    setFilteredData(filterTree(dataSource));
#else
    setFilteredData(dataSource);
#end
  };

  // 重置
  const handleReset = () => {
    searchForm.resetFields();
    setFilteredData(dataSource);
  };

  // 新增（根节点）
  const handleAddRoot = () => {
    setEditId(undefined);
    setParentId(0);
    setModalVisible(true);
  };

  // 新增（子节点）
  const handleAdd = (record: ${className}) => {
    setEditId(undefined);
    setParentId(record.id);
    setModalVisible(true);
  };

  // 编辑
  const handleEdit = (record: ${className}) => {
    setEditId(record.id);
    setParentId(undefined);
    setModalVisible(true);
  };

  // 删除
  const handleDelete = async (id: number) => {
    try {
      await ${classNameFirstLower}Api.delete(id);
      message.success('删除成功');
      loadData();
    } catch (error: any) {
      // 错误消息已在 request.ts 中统一处理
    }
  };

  // 表格列定义
  const columns: ColumnsType<${className}> = [
#set($firstColumn = true)
#foreach($column in $columns)
#if(${column.listOperationResult})
#if($firstColumn)
    {
      title: '${column.columnComment}',
      dataIndex: '${column.javaField}',
      key: '${column.javaField}',
      width: 200,
    },
#set($firstColumn = false)
#else
    {
      title: '${column.columnComment}',
      dataIndex: '${column.javaField}',
      key: '${column.javaField}',
#if(${column.javaType} == "Integer" || ${column.javaType} == "Long")
      width: 100,
#elseif(${column.javaType} == "LocalDateTime")
      width: 180,
#else
      width: 150,
#end
#if(${column.dictType} && ${column.dictType} != "")
      render: (value: any) => get${column.javaField.substring(0,1).toUpperCase()}${column.javaField.substring(1)}Label(value),
#end
    },
#end
#end
#end
    {
      title: '操作',
      key: 'action',
      width: 250,
      fixed: 'right' as const,
      render: (_: any, record: ${className}) => (
        <Space size="small">
          {hasPermission('${moduleName}:${businessName}:create') && (
            <Button
              type="link"
              size="small"
              icon={<PlusOutlined />}
              onClick={() => handleAdd(record)}
            >
              新增
            </Button>
          )}
          {hasPermission('${moduleName}:${businessName}:update') && (
            <Button
              type="link"
              size="small"
              icon={<EditOutlined />}
              onClick={() => handleEdit(record)}
            >
              编辑
            </Button>
          )}
          {hasPermission('${moduleName}:${businessName}:delete') && (
            <Popconfirm
              title="确定删除吗？"
              onConfirm={() => handleDelete(record.id!)}
              okText="确定"
              cancelText="取消"
            >
              <Button type="link" size="small" danger icon={<DeleteOutlined />}>
                删除
              </Button>
            </Popconfirm>
          )}
        </Space>
      ),
    },
  ];

  return (
    <div>
      <Card>
#set($hasQueryConditions = false)
#foreach($column in $columns)
#if(${column.listOperation})
#set($hasQueryConditions = true)
#end
#end
#if($hasQueryConditions)
        {/* 搜索表单 */}
        <Form
          form={searchForm}
          layout="inline"
          onFinish={handleSearch}
          style={{ marginBottom: 16 }}
        >
#foreach($column in $columns)
#if(${column.listOperation})
          <Form.Item label="${column.columnComment}" name="${column.javaField}">
#if(${column.htmlType} == "select" && ${column.dictType} && ${column.dictType} != "")
            <DictSelect
              dictType="${column.dictType}"
              placeholder="请选择${column.columnComment}"
              style={{ width: 200 }}
              allowClear
#if(${column.javaType} == "Integer" || ${column.javaType} == "Long")
              valueType="number"
#end
            />
#else
            <Input placeholder="请输入${column.columnComment}" style={{ width: 200 }} />
#end
          </Form.Item>
#end
#end
          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit" icon={<SearchOutlined />}>
                查询
              </Button>
              <Button onClick={handleReset}>
                重置
              </Button>
            </Space>
          </Form.Item>
        </Form>

#end
        {/* 操作按钮 */}
        <div style={{ marginBottom: 16 }}>
          <Space>
            <Button
              icon={isAllExpanded ? <ShrinkOutlined /> : <ExpandOutlined />}
              onClick={handleToggleExpand}
            >
              {isAllExpanded ? '全部收起' : '全部展开'}
            </Button>
            {hasPermission('${moduleName}:${businessName}:create') && (
              <Button type="primary" icon={<PlusOutlined />} onClick={handleAddRoot}>
                新增
              </Button>
            )}
          </Space>
        </div>

        {/* 数据表格 */}
        <Table
          key={filteredData.length}
          columns={columns}
          dataSource={filteredData}
          loading={loading}
          rowKey="id"
          pagination={false}
          scroll={{ x: 'max-content' }}
          expandable={{
            expandedRowKeys: expandedRowKeys,
            onExpandedRowsChange: (expandedKeys) => setExpandedRowKeys([...expandedKeys]),
          }}
        />
      </Card>

      <${className}Form
        visible={modalVisible}
        editId={editId}
        parentId={parentId}
        onClose={() => {
          setModalVisible(false);
          setEditId(undefined);
          setParentId(undefined);
        }}
        onSuccess={() => {
          setModalVisible(false);
          setEditId(undefined);
          setParentId(undefined);
          loadData();
        }}
      />
    </div>
  );
};

export default ${className}List;